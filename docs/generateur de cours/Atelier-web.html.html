<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Atelier Web : Éditeur Visuel de Pages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .image-item { 
            position: relative; 
            aspect-ratio: 1; 
            border-radius: 6px; 
            overflow: hidden; 
            cursor: pointer; 
            transition: transform 0.2s ease; 
            border: 2px solid transparent; 
            background: #f0f0f0; 
        }
        .image-item:hover { transform: scale(1.02); }
        .image-item img { width: 100%; height: 100%; object-fit: cover; }
        .image-item.selected {
            border: 3px solid #3b82f6;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        .inserted-image {
            display: block;
            margin: 10px 0;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            max-width: 100%;
            height: auto;
        }
        .inserted-image:hover {
            border-color: #3b82f6;
        }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nw-resize;
            z-index: 101;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .resize-handle:hover {
            background: #2563eb;
            transform: scale(1.1);
        }
        .resize-handle-tl { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle-tr { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-handle-bl { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-handle-br { bottom: -6px; right: -6px; cursor: se-resize; }
        
        .image-toolbar {
            position: absolute;
            top: -50px;
            left: 0;
            background: rgba(59, 130, 246, 0.9);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            gap: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .toolbar-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .image-edit-container {
            position: relative;
            display: inline-block;
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        #editor {
            min-height: 500px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            font-size: 14px;
        }
        
        /* Styles pour préserver l'apparence du contenu chargé */
        #editor h1, #editor h2, #editor h3, #editor h4, #editor h5, #editor h6 {
            margin: 1em 0 0.5em 0;
            font-weight: bold;
        }
        #editor h1 { font-size: 2em; }
        #editor h2 { font-size: 1.5em; }
        #editor h3 { font-size: 1.17em; }
        #editor h4 { font-size: 1em; }
        #editor h5 { font-size: 0.83em; }
        #editor h6 { font-size: 0.67em; }
        
        #editor p {
            margin: 1em 0;
        }
        
        /* Nouveaux styles pour la barre d'outils */
        .editor-toolbar {
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .toolbar-group {
            display: flex;
            gap: 5px;
            padding: 0 5px;
            border-right: 1px solid #d1d5db;
        }
        .toolbar-group:last-child {
            border-right: none;
        }
        .toolbar-btn-small {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            color: #4b5563;
            transition: all 0.2s;
        }
        .toolbar-btn-small:hover {
            background: #e5e7eb;
            color: #1f2937;
        }
        .toolbar-btn-small.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            background: #ef4444;
        }
        
        /* Styles pour le drag and drop */
        .drag-over {
            background-color: #dbeafe !important;
            border: 2px dashed #3b82f6 !important;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loadedStyles"></div>
    
    <div class="notification" id="notification">
        <i class="fas fa-info-circle" id="notificationIcon"></i>
        <span id="notificationText">Message</span>
    </div>

    <div class="flex flex-col h-screen">
        <header class="bg-white shadow p-4">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-700">Mon Atelier Web : Éditeur Visuel de Pages</h1>
                <div class="flex items-center gap-4">
                    <input type="file" id="htmlFile" accept=".html" class="hidden">
                    <button onclick="loadHTML()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-upload mr-2"></i> Charger HTML
                    </button>
                    <button onclick="switchToIframe()" id="iframeBtn" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                        <i class="fas fa-eye mr-2"></i> Vue Navigateur
                    </button>
                    <button onclick="switchToEditor()" id="editorBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-edit mr-2"></i> Mode Édition
                    </button>
                    <button onclick="exportHTML()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-download mr-2"></i> Exporter HTML
                    </button>
                    <button onclick="exportSeparateFiles()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                        <i class="fas fa-download mr-2"></i> Télécharger avec Images
                    </button>
                </div>
            </div>
        </header>
        
        <div class="editor-toolbar bg-white">
            <div class="toolbar-group">
                <button onclick="formatText('bold')" class="toolbar-btn-small" title="Gras">
                    <i class="fas fa-bold"></i>
                </button>
                <button onclick="formatText('italic')" class="toolbar-btn-small" title="Italique">
                    <i class="fas fa-italic"></i>
                </button>
                <button onclick="formatText('underline')" class="toolbar-btn-small" title="Souligné">
                    <i class="fas fa-underline"></i>
                </button>
            </div>
            
            <div class="toolbar-group">
                <button onclick="formatText('justifyLeft')" class="toolbar-btn-small" title="Aligner à gauche">
                    <i class="fas fa-align-left"></i>
                </button>
                <button onclick="formatText('justifyCenter')" class="toolbar-btn-small" title="Centrer">
                    <i class="fas fa-align-center"></i>
                </button>
                <button onclick="formatText('justifyRight')" class="toolbar-btn-small" title="Aligner à droite">
                    <i class="fas fa-align-right"></i>
                </button>
            </div>
            
            <div class="toolbar-group">
                <button onclick="undo()" class="toolbar-btn-small" title="Annuler">
                    <i class="fas fa-undo"></i>
                </button>
                <button onclick="redo()" class="toolbar-btn-small" title="Refaire">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>

        <main class="flex-grow flex gap-4 p-4">
            <div class="w-1/3 bg-white rounded-lg shadow-lg p-4">
                <h2 class="text-lg font-semibold mb-4">Palette d'Images</h2>
                <input type="file" id="imageFiles" accept="image/*" multiple class="hidden">
                <button onclick="document.getElementById('imageFiles').click()" 
                        class="w-full p-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 mb-4">
                    <i class="fas fa-plus mr-2"></i> Ajouter des images
                </button>
                <button onclick="pasteImageFromClipboard()" 
                        class="w-full p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 mb-4">
                    <i class="fas fa-paste mr-2"></i> Coller image (Ctrl+V)
                </button>
                <div class="text-xs text-gray-500 mb-4 p-2 bg-blue-50 rounded">
                    💡 <strong>Images depuis internet :</strong><br>
                    1. Clic droit sur une image → "Copier l'image"<br>
                    2. Cliquez "Coller image" ci-dessus<br>
                </div>
                <div id="imageGrid" class="grid grid-cols-3 gap-2">
                    </div>
            </div>

            <div class="flex-grow bg-white rounded-lg shadow-lg p-4">
                <h2 class="text-lg font-semibold mb-4">Éditeur</h2>
                
                <div id="editor" contenteditable="true" style="display: block;">
                    <div style="color: #333; font-family: sans-serif; padding: 20px;">
                        <p style="margin: 0 0 1em 0;">Modifiez le contenu de vos pages web en toute simplicité, sans toucher à une seule ligne de code ! <strong>Mon Atelier Web</strong> est votre outil tout-en-un pour mettre à jour textes et images sur n'importe quelle page HTML.</p>
                        <p style="margin: 0 0 1em 0;">Chargez votre fichier, effectuez vos changements de manière visuelle et téléchargez votre page mise à jour, prête à être mise en ligne.</p>
                        <h4 style="margin: 1.5em 0 0.5em 0; font-size: 1.1em; font-weight: bold;">Ce que vous pouvez faire :</h4>
                        <ul style="list-style-type: none; padding-left: 0; margin: 0;">
                            <li style="margin-bottom: 0.5em;">✏️ <strong>Modifier les textes</strong> directement sur la page, comme dans un traitement de texte.</li>
                            <li style="margin-bottom: 0.5em;">🖼️ <strong>Ajouter facilement des images</strong> depuis votre ordinateur ou en les copiant directement depuis un site web.</li>
                            <li style="margin-bottom: 0.5em;">✂️ <strong>Retoucher vos images</strong> : redimensionnez-les, alignez-les ou supprimez-les d'un simple clic.</li>
                            <li style="margin-bottom: 0.5em;">👀 <strong>Prévisualiser vos modifications</strong> en temps réel pour voir exactement à quoi ressemblera votre page.</li>
                            <li style="margin-bottom: 0.5em;">📥 <strong>Exporter votre travail</strong> sous la forme d'un fichier web complet, avec les images optimisées pour un chargement rapide.</li>
                        </ul>
                        <p style="margin-top: 1.5em; font-style: italic; color: #555;">Idéal pour les mises à jour rapides, la correction de contenu ou la personnalisation de modèles de page sans avoir besoin d'un développeur.</p>
                    </div>
                </div>
                
                <iframe id="previewFrame" style="width: 100%; height: 500px; border: 1px solid #e5e7eb; border-radius: 8px; display: none;"></iframe>
            </div>
        </main>
    </div>

    <script>
        // Variables globales
        let images = [];
        let insertionMode = false;
        let selectedImage = null;
        let editingImage = null;
        let isResizing = false;
        let originalHtmlContent = null;
        let originalHtmlDocument = null;
        let history = [];
        let historyStep = -1;

        // Fonction de notification
        function showMessage(text, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            
            // Réinitialiser les classes
            notification.className = 'notification';
            
            switch(type) {
                case 'error':
                    notification.classList.add('error');
                    icon.className = 'fas fa-exclamation-circle';
                    break;
                default:
                    icon.className = 'fas fa-check-circle';
            }
            
            document.getElementById('notificationText').textContent = text;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Gestion des fichiers images avec compression automatique
        document.getElementById('imageFiles').addEventListener('change', function(e) {
            Array.from(e.target.files).forEach(async (file) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            // Compresser l'image pour éviter les fichiers trop lourds
                            const originalDataUrl = e.target.result;
                            const compressedDataUrl = await compressImage(originalDataUrl, 0.9, 1600);
                            
                            const image = {
                                name: file.name,
                                dataUrl: compressedDataUrl
                            };
                            images.push(image);
                            renderImageGrid();
                            showMessage(`Image ${file.name} ajoutée et optimisée`);
                        } catch (error) {
                            // En cas d'erreur, utiliser l'image originale
                            const image = {
                                name: file.name,
                                dataUrl: e.target.result
                            };
                            images.push(image);
                            renderImageGrid();
                            showMessage(`Image ${file.name} ajoutée`);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        function renderImageGrid() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '';
            
            images.forEach((image, index) => {
                const div = document.createElement('div');
                div.className = 'image-item';
                div.innerHTML = `<img src="${image.dataUrl}" alt="${image.name}" title="${image.name}">`;
                
                div.addEventListener('click', function() {
                    selectedImage = image;
                    insertionMode = true;
                    
                    // Mettre en surbrillance l'image sélectionnée
                    document.querySelectorAll('.image-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    const editor = document.getElementById('editor');
                    editor.style.cursor = 'crosshair';
                    editor.style.backgroundColor = 'rgba(59, 130, 246, 0.05)';
                    
                    showMessage('Cliquez dans l\'éditeur pour insérer l\'image');
                });
                
                grid.appendChild(div);
            });
        }

        // Gestion des clics dans l'éditeur
        document.getElementById('editor').addEventListener('click', function(e) {
            if (insertionMode && selectedImage) {
                e.preventDefault();
                
                // Créer l'élément image
                const img = document.createElement('img');
                img.src = selectedImage.dataUrl;
                img.alt = selectedImage.name;
                img.className = 'inserted-image';
                img.setAttribute('data-filename', selectedImage.name);
                
                // Ajouter les gestionnaires d'événements pour l'édition
                setupImageEditing(img);
                
                // Insérer à la position du clic
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.insertNode(img);
                    
                    // Placer le curseur après l'image
                    range.setStartAfter(img);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    // Si pas de sélection, insérer à la fin
                    this.appendChild(img);
                }
                
                // Réinitialiser le mode insertion
                insertionMode = false;
                selectedImage = null;
                this.style.cursor = '';
                this.style.backgroundColor = '';
                
                // Désélectionner l'image dans la palette
                document.querySelectorAll('.image-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                showMessage('Image insérée avec succès!');
                saveHistory();
                
                // Synchroniser automatiquement avec l'iframe si elle est visible
                if (document.getElementById('previewFrame').style.display === 'block') {
                    updateIframeContent();
                }
            } else if (e.target.tagName === 'IMG' && !insertionMode) {
                // Clic sur une image existante pour l'éditer
                e.preventDefault();
                startImageEditing(e.target);
            } else if (editingImage && !e.target.closest('.image-toolbar') && !e.target.classList.contains('resize-handle')) {
                // Clic ailleurs - arrêter l'édition
                stopImageEditing();
            }
        });

        // Configuration de l'édition d'image
        function setupImageEditing(img) {
            img.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                startImageEditing(this);
            });
        }

        // Démarrer l'édition d'une image
        function startImageEditing(img) {
            // Arrêter l'édition précédente
            stopImageEditing();
            
            editingImage = img;
            img.classList.add('image-editing');
            
            // Créer un conteneur pour l'image et ses outils
            const container = document.createElement('div');
            container.style.position = 'relative';
            container.style.display = 'inline-block';
            container.className = 'image-edit-container';
            
            // Envelopper l'image dans le conteneur
            img.parentNode.insertBefore(container, img);
            container.appendChild(img);
            
            // Créer la barre d'outils
            const toolbar = document.createElement('div');
            toolbar.className = 'image-toolbar';
            toolbar.innerHTML = `
                <button class="toolbar-btn" onclick="alignImage('left')">←</button>
                <button class="toolbar-btn" onclick="alignImage('center')">●</button>
                <button class="toolbar-btn" onclick="alignImage('right')">→</button>
                <button class="toolbar-btn" onclick="deleteImage()">🗑</button>
            `;
            
            // Créer les 4 poignées de redimensionnement
            ['tl', 'tr', 'bl', 'br'].forEach(position => {
                const resizeHandle = document.createElement('div');
                resizeHandle.className = `resize-handle resize-handle-${position}`;
                resizeHandle.addEventListener('mousedown', (e) => startResize(e, position));
                container.appendChild(resizeHandle);
            });
            
            // Ajouter toolbar au conteneur
            container.appendChild(toolbar);
        }

        // Arrêter l'édition d'image
        function stopImageEditing() {
            if (editingImage) {
                editingImage.classList.remove('image-editing');
                
                // Trouver et supprimer le conteneur d'édition
                const container = editingImage.closest('.image-edit-container');
                if (container) {
                    // Sortir l'image du conteneur
                    container.parentNode.insertBefore(editingImage, container);
                    // Supprimer le conteneur
                    container.remove();
                }
                
                editingImage = null;
            }
        }

        // Aligner une image
        function alignImage(alignment) {
            if (!editingImage) return;
            
            switch(alignment) {
                case 'left':
                    editingImage.style.display = 'block';
                    editingImage.style.marginLeft = '0';
                    editingImage.style.marginRight = 'auto';
                    break;
                case 'center':
                    editingImage.style.display = 'block';
                    editingImage.style.marginLeft = 'auto';
                    editingImage.style.marginRight = 'auto';
                    break;
                case 'right':
                    editingImage.style.display = 'block';
                    editingImage.style.marginLeft = 'auto';
                    editingImage.style.marginRight = '0';
                    break;
            }
            showMessage(`Image alignée à ${alignment === 'center' ? 'au centre' : 'à ' + alignment}`);
            
            // Synchroniser avec l'iframe si visible
            if (document.getElementById('previewFrame').style.display === 'block') {
                updateIframeContent();
            }
        }

        // Supprimer une image
        function deleteImage() {
            if (!editingImage) return;
            
            if (confirm('Voulez-vous vraiment supprimer cette image ?')) {
                const container = editingImage.closest('.image-edit-container');
                if (container) {
                    container.remove();
                } else {
                    editingImage.remove();
                }
                editingImage = null;
                showMessage('Image supprimée');
                saveHistory();
            }
        }

        // Démarrer le redimensionnement
        function startResize(e, position) {
            if (!editingImage) return;
            
            isResizing = true;
            const startX = e.clientX;
            const startY = e.clientY;
            
            // Obtenir les dimensions actuelles de l'image
            const currentWidth = editingImage.offsetWidth;
            const currentHeight = editingImage.offsetHeight;
            
            // Calculer le ratio d'aspect
            const aspectRatio = currentHeight / currentWidth;
            
            function doResize(e) {
                if (!isResizing) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                let newWidth = currentWidth;
                
                // Calculer la nouvelle largeur selon la position de la poignée
                if (position.includes('r')) { // poignées droites (tr, br)
                    newWidth = currentWidth + deltaX;
                } else if (position.includes('l')) { // poignées gauches (tl, bl)
                    newWidth = currentWidth - deltaX;
                }
                
                // Limiter les dimensions minimales et maximales
                newWidth = Math.max(50, Math.min(800, newWidth));
                const newHeight = newWidth * aspectRatio;
                
                editingImage.style.width = newWidth + 'px';
                editingImage.style.height = newHeight + 'px';
                editingImage.style.maxWidth = 'none';
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                showMessage(`Image redimensionnée : ${editingImage.offsetWidth}px`);
                saveHistory();
                
                // Synchroniser avec l'iframe si visible
                if (document.getElementById('previewFrame').style.display === 'block') {
                    updateIframeContent();
                }
            }
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
            e.stopPropagation();
        }

        // Charger un fichier HTML - VERSION SIMPLIFIÉE ET CORRIGÉE
        function loadHTML() {
            document.getElementById('htmlFile').click();
        }

        document.getElementById('htmlFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const htmlContent = e.target.result;
                    
                    // Sauvegarder le contenu HTML original complet
                    originalHtmlContent = htmlContent;
                    
                    // Sauvegarder le document HTML original complet
                    const parser = new DOMParser();
                    originalHtmlDocument = parser.parseFromString(htmlContent, 'text/html');
                    
                    // Extraire seulement le contenu du body pour l'éditeur
                    const bodyContent = originalHtmlDocument.querySelector('body');
                    if (bodyContent) {
                        document.getElementById('editor').innerHTML = bodyContent.innerHTML;
                    } else {
                        // Si pas de body, utiliser tout le contenu
                        document.getElementById('editor').innerHTML = htmlContent;
                    }
                    
                    // Injecter les styles CSS du document original
                    injectOriginalStyles();
                    
                    // Activer l'édition pour toutes les images déjà présentes
                    const existingImages = document.querySelectorAll('#editor img');
                    existingImages.forEach(img => {
                        img.classList.add('inserted-image');
                        setupImageEditing(img);
                    });
                    
                    saveHistory();
                    showMessage('Fichier HTML chargé avec succès!');
                };
                reader.readAsText(file);
            }
        });

        // Injection des styles originaux - VERSION CORRIGÉE
        function injectOriginalStyles() {
            if (!originalHtmlContent) return;
            
            // Vider les styles précédents
            const loadedStyles = document.getElementById('loadedStyles');
            loadedStyles.innerHTML = '';
            
            // Parser le HTML original
            const parser = new DOMParser();
            const doc = parser.parseFromString(originalHtmlContent, 'text/html');
            
            // Extraire et adapter les styles CSS
            const styles = doc.querySelectorAll('style');
            let adaptedStyles = '';
            
            styles.forEach(style => {
                adaptedStyles += style.innerHTML + '\n';
            });
            
            // Remplacer les sélecteurs body et html par #editor
            adaptedStyles = adaptedStyles.replace(/\bbody\b/g, '#editor');
            adaptedStyles = adaptedStyles.replace(/\bhtml\b/g, '#editor');
            
            // Ajouter des styles de base pour forcer l'affichage de tout le contenu
            adaptedStyles += `
                #editor {
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                }
                #editor * {
                    visibility: visible !important;
                }
                #editor [data-animate] {
                    opacity: 1 !important;
                    transform: translateY(0) !important;
                }
                #editor img {
                    max-width: 100%;
                    height: auto;
                    display: inline-block;
                    cursor: pointer;
                }
                #editor img.selected {
                    border: 2px solid #3b82f6;
                    box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
                }
                #editor img.resizing {
                    pointer-events: none;
                }
            `;
            
            // Créer et injecter l'élément style
            const styleElement = document.createElement('style');
            styleElement.textContent = adaptedStyles;
            loadedStyles.appendChild(styleElement);
            
            // Extraire et injecter les liens CSS
            const links = doc.querySelectorAll('link[rel="stylesheet"]');
            links.forEach(link => {
                const newLink = document.createElement('link');
                newLink.rel = 'stylesheet';
                newLink.href = link.href;
                loadedStyles.appendChild(newLink);
            });
        }

        // Switch entre les modes
        function switchToIframe() {
            document.getElementById('editor').style.display = 'none';
            document.getElementById('previewFrame').style.display = 'block';
            document.getElementById('iframeBtn').className = 'px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700';
            document.getElementById('editorBtn').className = 'px-4 py-2 bg-gray-400 text-white rounded-lg';
            
            // Synchroniser le contenu modifié avec l'iframe
            updateIframeContent();
        }

        function switchToEditor() {
            document.getElementById('editor').style.display = 'block';
            document.getElementById('previewFrame').style.display = 'none';
            document.getElementById('iframeBtn').className = 'px-4 py-2 bg-gray-400 text-white rounded-lg';
            document.getElementById('editorBtn').className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
        }

        function updateIframeContent() {
            if (originalHtmlDocument) {
                // Récupérer le contenu modifié de l'éditeur
                const modifiedContent = document.getElementById('editor').innerHTML;
                
                // Créer une copie du document original et remplacer le body
                const updatedDoc = originalHtmlDocument.cloneNode(true);
                const bodyElement = updatedDoc.querySelector('body');
                if (bodyElement) {
                    bodyElement.innerHTML = modifiedContent;
                } else {
                    // Si pas de body, créer la structure
                    const newBody = updatedDoc.createElement('body');
                    newBody.innerHTML = modifiedContent;
                    updatedDoc.documentElement.appendChild(newBody);
                }
                
                let finalContent = updatedDoc.documentElement.outerHTML;
                
                // Ajouter des styles pour forcer l'affichage dans l'iframe
                const forceDisplayStyles = `
                    <style>
                        [data-animate] { opacity: 1 !important; transform: translateY(0) !important; }
                        body { display: block !important; visibility: visible !important; }
                    </style>
                `;
                
                // Injecter les styles dans le head du document
                const headEndIndex = finalContent.indexOf('</head>');
                if (headEndIndex !== -1) {
                    finalContent = finalContent.substring(0, headEndIndex) + forceDisplayStyles + finalContent.substring(headEndIndex);
                }
                
                // Mettre à jour l'iframe avec le contenu synchronisé
                const iframe = document.getElementById('previewFrame');
                iframe.srcdoc = finalContent;
            } else if (originalHtmlContent) {
                // Fallback : utiliser le contenu original
                const iframe = document.getElementById('previewFrame');
                iframe.srcdoc = originalHtmlContent;
            }
        }

        // Fonctions de formatage
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('editor').focus();
            saveHistory();
        }

        // Historique
        function saveHistory() {
            historyStep++;
            if (historyStep < history.length) {
                history.length = historyStep;
            }
            history.push(document.getElementById('editor').innerHTML);
            
            // Limiter la taille de l'historique
            if (history.length > 50) {
                history.shift();
                historyStep--;
            }
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                document.getElementById('editor').innerHTML = history[historyStep];
                // Rétablir les gestionnaires d'événements des images
                const existingImages = document.querySelectorAll('#editor img');
                existingImages.forEach(img => {
                    img.classList.add('inserted-image');
                    setupImageEditing(img);
                });
                showMessage('Action annulée');
            }
        }

        function redo() {
            if (historyStep < history.length - 1) {
                historyStep++;
                document.getElementById('editor').innerHTML = history[historyStep];
                // Rétablir les gestionnaires d'événements des images
                const existingImages = document.querySelectorAll('#editor img');
                existingImages.forEach(img => {
                    img.classList.add('inserted-image');
                    setupImageEditing(img);
                });
                showMessage('Action restaurée');
            }
        }

        // Fonction pour compresser une image
        function compressImage(dataUrl, quality = 0.8, maxWidth = 1200) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculer les nouvelles dimensions en gardant le ratio
                    let { width, height } = img;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Dessiner l'image redimensionnée
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Obtenir l'image compressée en JPEG (plus léger que PNG)
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                img.src = dataUrl;
            });
        }

        // Export HTML avec compression des images
        async function exportHTML() {
            stopImageEditing();
            
            showMessage('Compression des images en cours...', 'info');
            
            // Obtenir le contenu de l'éditeur
            let editorContent = document.getElementById('editor').innerHTML;
            
            // Trouver toutes les images base64 dans le contenu
            const base64Images = editorContent.match(/data:image\/[^;]+;base64,[^"'\s]+/g) || [];
            
            // Compresser chaque image
            for (const originalDataUrl of base64Images) {
                try {
                    const compressedDataUrl = await compressImage(originalDataUrl, 0.85, 1200);
                    editorContent = editorContent.replace(originalDataUrl, compressedDataUrl);
                } catch (error) {
                    console.error('Erreur compression image:', error);
                }
            }
            
            let content;
            if (originalHtmlDocument) {
                // Si nous avons un document chargé, nous l'utilisons comme base
                const updatedDoc = originalHtmlDocument.cloneNode(true);
                const bodyElement = updatedDoc.querySelector('body');
                if (bodyElement) {
                    bodyElement.innerHTML = editorContent;
                }
                
                content = updatedDoc.documentElement.outerHTML;
            } else {
                // Sinon, nous créons un document HTML complet
                content = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document exporté</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }
        img { max-width: 100%; height: auto; }
    </style>
</head>
<body>
    ${editorContent}
</body>
</html>`;
            }
            
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document-edite.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const fileSizeKB = Math.round(blob.size / 1024);
            showMessage(`Document exporté (${fileSizeKB} KB) avec images compressées!`);
        }



        // Export de fichiers séparés (sans ZIP) pour éviter les blocages Windows
        async function exportSeparateFiles() {
            if (!originalHtmlContent) {
                showMessage('Aucun fichier HTML chargé', 'error');
                return;
            }
            
            showMessage('Préparation des fichiers séparés...', 'info');
            
            // Créer un nom de projet basé sur la date/heure
            const now = new Date();
            const projectName = `site-${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}`;
            
            // Obtenir le contenu modifié
            const modifiedContent = document.getElementById('editor').innerHTML;
            
            // Créer le document final avec le contenu modifié
            const parser = new DOMParser();
            const doc = parser.parseFromString(originalHtmlContent, 'text/html');
            const bodyElement = doc.querySelector('body');
            if (bodyElement) {
                bodyElement.innerHTML = modifiedContent;
            }
            
            let finalHtml = doc.documentElement.outerHTML;
            let imageCounter = 1;
            const filesToDownload = [];
            
            // Traiter toutes les images - chercher directement dans l'éditeur
            const editorElement = document.getElementById('editor');
            const imgElements = editorElement.querySelectorAll('img');
            
            console.log('Images trouvées dans l\'éditeur:', imgElements.length);
            
            for (const img of imgElements) {
                const src = img.src;
                console.log('Processing image:', src.substring(0, 50) + '...', 'starts with data:', src.startsWith('data:'));
                
                if (src.startsWith('data:')) {
                    // Image en base64 - la compresser et préparer pour téléchargement
                    const dataMatch = src.match(/^data:image\/([^;]+);base64,(.+)$/);
                    if (dataMatch) {
                        try {
                            // Compresser l'image
                            const compressedDataUrl = await compressImage(src, 0.85, 1200);
                            const compressedMatch = compressedDataUrl.match(/^data:image\/([^;]+);base64,(.+)$/);
                            
                            if (compressedMatch) {
                                const compressedBase64 = compressedMatch[2];
                                const filename = `${projectName}_image_${imageCounter}.jpg`;
                                
                                console.log('Ajout image:', filename);
                                
                                // Convertir base64 en blob
                                const byteCharacters = atob(compressedBase64);
                                const byteNumbers = new Array(byteCharacters.length);
                                for (let i = 0; i < byteCharacters.length; i++) {
                                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                                }
                                const byteArray = new Uint8Array(byteNumbers);
                                const blob = new Blob([byteArray], { type: 'image/jpeg' });
                                
                                // Ajouter à la liste des fichiers à télécharger
                                filesToDownload.push({
                                    filename: filename,
                                    blob: blob
                                });
                                
                                // Remplacer le src dans le HTML
                                finalHtml = finalHtml.replace(src, filename);
                                imageCounter++;
                            }
                        } catch (error) {
                            console.error('Erreur compression:', error);
                        }
                    }
                }
            }
            
            // Ajouter le fichier HTML à la liste
            const htmlBlob = new Blob([finalHtml], { type: 'text/html' });
            filesToDownload.unshift({
                filename: `${projectName}.html`,
                blob: htmlBlob
            });
            
            // Télécharger tous les fichiers un par un avec un délai
            showMessage(`Téléchargement de ${filesToDownload.length} fichiers pour le projet "${projectName}"...`, 'info');
            
            for (let i = 0; i < filesToDownload.length; i++) {
                const file = filesToDownload[i];
                
                setTimeout(() => {
                    const url = URL.createObjectURL(file.blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.filename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Message de progression
                    if (i === 0) {
                        showMessage(`Téléchargement de ${file.filename}...`, 'info');
                    } else if (i === filesToDownload.length - 1) {
                        setTimeout(() => {
                            showMessage(`✅ ${filesToDownload.length} fichiers téléchargés ! 
                            
📁 Instructions :
1. Allez dans votre dossier Téléchargements  
2. Créez un nouveau dossier "${projectName}"
3. Déplacez tous les fichiers "${projectName}*" dans ce dossier
4. Ouvrez le fichier "${projectName}.html" dans ce dossier`, 'info');
                        }, 500);
                    }
                }, i * 500); // Délai de 500ms entre chaque téléchargement
            }
        }

        // Fonction pour coller une image depuis le presse-papiers avec compression
        async function pasteImageFromClipboard() {
            try {
                const clipboardItems = await navigator.clipboard.read();
                
                for (const clipboardItem of clipboardItems) {
                    for (const type of clipboardItem.types) {
                        if (type.startsWith('image/')) {
                            const blob = await clipboardItem.getType(type);
                            const reader = new FileReader();
                            
                            reader.onload = async function(e) {
                                try {
                                    // Compresser l'image collée
                                    const originalDataUrl = e.target.result;
                                    const compressedDataUrl = await compressImage(originalDataUrl, 0.9, 1600);
                                    
                                    const image = {
                                        name: `image-collée-${Date.now()}.jpg`,
                                        dataUrl: compressedDataUrl
                                    };
                                    images.push(image);
                                    renderImageGrid();
                                    showMessage('Image collée et optimisée depuis le presse-papiers !');
                                } catch (error) {
                                    // En cas d'erreur, utiliser l'image originale
                                    const image = {
                                        name: `image-collée-${Date.now()}.${type.split('/')[1]}`,
                                        dataUrl: e.target.result
                                    };
                                    images.push(image);
                                    renderImageGrid();
                                    showMessage('Image collée depuis le presse-papiers !');
                                }
                            };
                            
                            reader.readAsDataURL(blob);
                            return;
                        }
                    }
                }
                
                showMessage('Aucune image trouvée dans le presse-papiers', 'error');
            } catch (err) {
                console.error('Erreur presse-papiers:', err);
                showMessage('Erreur : Copiez d\'abord une image avec clic droit → Copier l\'image', 'error');
            }
        }

        // Support Ctrl+V global
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'v' && !e.target.matches('input, textarea, [contenteditable]')) {
                e.preventDefault();
                pasteImageFromClipboard();
            }
            
            // Ctrl+Z pour annuler
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            
            // Ctrl+Y pour refaire
            if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        });

        // Gestion du drag and drop pour images d'internet
        const imageGrid = document.getElementById('imageGrid');
        
        // Drag over sur la palette d'images
        imageGrid.addEventListener('dragover', function(e) { 
            e.preventDefault(); 
            this.classList.add('drag-over');
        });
        
        imageGrid.addEventListener('dragleave', function(e) {
            // Vérifier si on quitte vraiment la zone (pas un enfant)
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drag-over');
            }
        });
        
        imageGrid.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            // Vérifier s'il y a des fichiers locaux
            if (e.dataTransfer.files.length > 0) {
                // Traiter les fichiers locaux
                Array.from(e.dataTransfer.files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const image = {
                                name: file.name,
                                dataUrl: e.target.result
                            };
                            images.push(image);
                            renderImageGrid();
                            showMessage(`Image ${file.name} ajoutée`);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            } else {
                // Essayer de récupérer une image depuis internet
                const htmlData = e.dataTransfer.getData('text/html');
                const textData = e.dataTransfer.getData('text/plain');
                
                // Chercher une URL d'image dans les données HTML
                let imageUrl = null;
                
                if (htmlData) {
                    const imgMatch = htmlData.match(/<img[^>]+src="([^"]+)"/i);
                    if (imgMatch && imgMatch[1]) {
                        imageUrl = imgMatch[1];
                    }
                }
                
                // Si pas trouvé dans HTML, vérifier si le texte est une URL d'image
                if (!imageUrl && textData) {
                    if (textData.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i) || textData.startsWith('data:image/')) {
                        imageUrl = textData;
                    }
                }
                
                if (imageUrl) {
                    showMessage('Téléchargement de l\'image en cours...', 'info');
                    
                    if (imageUrl.startsWith('data:')) {
                        // Image en base64 déjà encodée
                        const image = {
                            name: `image-web-${Date.now()}.png`,
                            dataUrl: imageUrl
                        };
                        images.push(image);
                        renderImageGrid();
                        showMessage('Image web ajoutée à la palette !');
                    } else {
                        // Image externe - essayer de la télécharger
                        downloadImageFromUrl(imageUrl);
                    }
                } else {
                    showMessage('Aucune image détectée dans les données glissées', 'error');
                }
            }
        });
        
        // Fonction pour télécharger une image depuis une URL
        async function downloadImageFromUrl(imageUrl) {
            try {
                // Essayer d'abord une requête directe
                const response = await fetch(imageUrl, {
                    mode: 'cors'
                }).catch(() => {
                    // Si CORS échoue, essayer avec un proxy
                    return fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(imageUrl)}`);
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    
                    // Vérifier que c'est bien une image
                    if (!blob.type.startsWith('image/')) {
                        throw new Error('Le fichier téléchargé n\'est pas une image');
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const image = {
                            name: `image-web-${Date.now()}.${blob.type.split('/')[1]}`,
                            dataUrl: e.target.result
                        };
                        images.push(image);
                        renderImageGrid();
                        showMessage('Image web ajoutée à la palette !');
                    };
                    reader.readAsDataURL(blob);
                } else {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
            } catch (error) {
                console.error('Erreur téléchargement image:', error);
                showMessage('Impossible de télécharger l\'image. Essayez la méthode copier-coller (Ctrl+V)', 'error');
            }
        }
        
        // Drag and drop sur l'éditeur aussi (pour insérer directement)
        const editor = document.getElementById('editor');
        
        editor.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.backgroundColor = 'rgba(59, 130, 246, 0.05)';
        });
        
        editor.addEventListener('dragleave', function(e) {
            if (!this.contains(e.relatedTarget)) {
                this.style.backgroundColor = '';
            }
        });
        
        editor.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.backgroundColor = '';
            
            // Si on est en mode insertion, ne pas traiter le drop ici
            if (insertionMode) return;
            
            // Vérifier s'il y a des fichiers locaux
            if (e.dataTransfer.files.length > 0) {
                Array.from(e.dataTransfer.files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // Créer et insérer l'image directement
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = file.name;
                            img.className = 'inserted-image';
                            img.setAttribute('data-filename', file.name);
                            
                            setupImageEditing(img);
                            
                            // Insérer à la position du drop
                            const range = document.caretRangeFromPoint(e.clientX, e.clientY);
                            if (range) {
                                range.insertNode(img);
                            } else {
                                editor.appendChild(img);
                            }
                            
                            showMessage(`Image ${file.name} insérée directement`);
                            saveHistory();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            } else {
                // Traiter les images web
                const htmlData = e.dataTransfer.getData('text/html');
                const textData = e.dataTransfer.getData('text/plain');
                
                let imageUrl = null;
                
                if (htmlData) {
                    const imgMatch = htmlData.match(/<img[^>]+src="([^"]+)"/i);
                    if (imgMatch && imgMatch[1]) {
                        imageUrl = imgMatch[1];
                    }
                }
                
                if (!imageUrl && textData) {
                    if (textData.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i) || textData.startsWith('data:image/')) {
                        imageUrl = textData;
                    }
                }
                
                if (imageUrl) {
                    showMessage('Téléchargement et insertion de l\'image...', 'info');
                    
                    if (imageUrl.startsWith('data:')) {
                        // Image en base64
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = `image-web-${Date.now()}`;
                        img.className = 'inserted-image';
                        img.setAttribute('data-filename', img.alt);
                        
                        setupImageEditing(img);
                        
                        const range = document.caretRangeFromPoint(e.clientX, e.clientY);
                        if (range) {
                            range.insertNode(img);
                        } else {
                            editor.appendChild(img);
                        }
                        
                        showMessage('Image web insérée directement !');
                        saveHistory();
                    } else {
                        // Télécharger et insérer
                        downloadAndInsertImage(imageUrl, e.clientX, e.clientY);
                    }
                }
            }
        });
        
        // Fonction pour télécharger et insérer une image directement
        async function downloadAndInsertImage(imageUrl, x, y) {
            try {
                const response = await fetch(imageUrl, {
                    mode: 'cors'
                }).catch(() => {
                    return fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(imageUrl)}`);
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    
                    if (!blob.type.startsWith('image/')) {
                        throw new Error('Le fichier téléchargé n\'est pas une image');
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = `image-web-${Date.now()}`;
                        img.className = 'inserted-image';
                        img.setAttribute('data-filename', img.alt);
                        
                        setupImageEditing(img);
                        
                        const range = document.caretRangeFromPoint(x, y);
                        if (range) {
                            range.insertNode(img);
                        } else {
                            document.getElementById('editor').appendChild(img);
                        }
                        
                        showMessage('Image web insérée directement !');
                        saveHistory();
                    };
                    reader.readAsDataURL(blob);
                } else {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
            } catch (error) {
                console.error('Erreur téléchargement image:', error);
                showMessage('Impossible de télécharger l\'image. Utilisez copier-coller (Ctrl+V)', 'error');
            }
        }

        // Initialisation
        saveHistory(); // Sauvegarder l'état initial
    </script>
</body>
</html>